const citaAdmin={id:"",nombre:"",fecha:"",hora:"",servicios:[]};function iniciarApp(){generarHorarios(),gestionarModalObservaciones(),mostrarHorariosCrear()}function ConfirmarHoraCrear(){const e=document.getElementById("fecha-nueva"),t=document.getElementById("hora-nueva");citaAdmin.fecha&&citaAdmin.hora&&(e.value=citaAdmin.fecha,t.value=citaAdmin.hora),CerrarHoraCrear(),cerrarCrearCita()}function cerrarModalAnular(){document.querySelector("#modal-observaciones-anular").style.display="none"}function eliminarCita(e){const t=e.getAttribute("data-id"),a=e.getAttribute("data-usuario-id"),o=e.getAttribute("data-email");console.log("el email",o),citaAdmin.usuarioId=a,citaAdmin.email=o,console.log(citaAdmin.usuarioId),console.log(citaAdmin.email),citaAdmin.id=t,console.log("ID de la cita a posponer: "+citaAdmin.id);const r=document.querySelector("#modal-observaciones-anular");r.style.display="block",r.classList.add("show"),setTimeout((()=>{r.style.animation="slideIn 0.5s forwards"}),10)}function AnularTurno(e){const t=citaAdmin.usuarioId,a=citaAdmin.id,o=citaAdmin.email;console.log("Longitud de la observación: ",e.length),console.log("email: ",o),console.log("cita: ",a),console.log("usuario: ",t);const r=document.getElementById("loading-spinner");r.classList.add("show"),e.length>=15&&a&&o?fetch("/api/anularCita",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({citaid:a,email:o,usuarioId:t,observacion:e})}).then((e=>e.text())).then((e=>{console.log("Respuesta cruda del servidor:",e);try{const t=JSON.parse(e);t.resultado?(r.classList.remove("show"),Swal.fire({icon:"success",title:"Cita Anulada",text:"La cita fue anulada correctamente.",button:"OK"}).then((()=>{setTimeout((()=>{window.location.reload()}),1e3)}))):alert("Hubo un problema al anular la cita: "+(t.error||"Error desconocido"))}catch(e){console.error("Error al parsear JSON:",e),alert("Hubo un error al procesar la respuesta del servidor")}})).catch((e=>{console.error("Error al enviar los datos:",e),alert("Hubo un error al enviar los datos al servidor")})):alert("Por favor, ingresa una observación válida de al menos 15 caracteres.")}var calendarVer,calendarDisponible,calendarPosponer;function inicializarCalendarioVer(){var e=document.getElementById("calendar-ver");document.getElementById("fecha"),document.getElementById("modal-seleccionar-turno");document.querySelector("#modal");var t=new Date;t.setHours(0,0,0,0),new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",headerToolbar:{left:"prev",center:"title",right:"next"},events:[],dateClick:function(e){new Date(e.dateStr).setHours(0,0,0,0),window.location=`?fecha=${e.dateStr}`},dayCellDidMount:function(e){var a=new Date(e.date);a.setHours(0,0,0,0),e.el.classList.remove("disabled-day"),e.el.classList.remove("current-day"),a.getTime()===t.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){e.start.getMonth(),e.start.getFullYear();const t=document.querySelector(".fc-prev-button"),a=document.querySelector(".fc-next-button");t.disabled=!1,a.disabled=!1}}).render()}function cerrarhorarioscrear(){const e=document.getElementById("modal-seleccionar-turno");e.style.animation="slideOut 0.5s forwards",setTimeout((()=>{e.style.display="none",e.classList.remove("mostrar"),modal.style.pointerEvents="auto",e.style.pointerEvents="none"}),500)}function cerrarCrearCita(){document.getElementById("modal-crearcita").style.display="none",document.getElementById("blur-background").style.display="none"}function VerCrearCita(){const e=document.getElementById("modal-crearcita");e.classList.add("show"),e.style.display="block",inicializarFechas(),setTimeout((function(){calendarDisponible?(console.log("hola"),calendarDisponible.updateSize()):console.error("calendarAdmin no está inicializado.")}),300)}function inicializarFechas(){var e=document.getElementById("calendar-crear"),t=document.getElementById("fechacrear"),a=document.getElementById("modal-seleccionar-turno"),o=new Date;o.setHours(0,0,0,0);var r=new Date(o);r.setDate(o.getDate()),(calendarDisponible=new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",headerToolbar:{left:"prev",center:"title",right:"next"},events:[],dateClick:function(e){var n=new Date(e.dateStr);n.setHours(0,0,0,0);var s=new Date(o);s.setDate(o.getDate()+30),n<r||n>s||(t.value=e.dateStr,citaAdmin.fecha=e.dateStr,a.style.display="block",a.classList.add("mostrar"),setTimeout((()=>{a.style.animation="slideIn 0.5s forwards"}),10),a.style.pointerEvents="auto")},dayCellDidMount:function(e){var t=new Date(e.date);t.setHours(0,0,0,0),t<=r&&e.el.classList.add("disabled-day");var a=new Date(o);a.setDate(o.getDate()+30),t>a&&e.el.classList.add("disabled-day"),t.getTime()===o.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){const t=e.start.getMonth(),a=e.start.getFullYear(),r=new Date(o);r.setMonth(o.getMonth()-1);document.querySelector(".fc-prev-button").disabled=t===r.getMonth()&&a===r.getFullYear();document.querySelector(".fc-next-button").disabled=t===o.getMonth()&&a===o.getFullYear()}})).render()}function posponerCita(e){const t=e.getAttribute("data-id"),a=e.getAttribute("data-email"),o=e.getAttribute("data-usuario-id");citaAdmin.email=a,citaAdmin.usuarioId=o,console.log(citaAdmin.usuarioId),citaAdmin.id=t,console.log("ID de la cita a posponer: "+citaAdmin.id);const r=document.getElementById("modal-posponer");r.classList.add("show"),r.style.display="block",inicializarCalendarioPosponer(t),setTimeout((function(){calendar3?(console.log("hola"),calendar3.updateSize()):console.error("calendarAdmin no está inicializado.")}),300)}function cerrarModalFecha(){document.getElementById("modal-posponer").style.display="none",document.getElementById("blur-background").style.display="none"}function cerrarModalHora(){document.getElementById("modal-seleccionar-turno").style.display="none",document.getElementById("blur-background").style.display="none"}function inicializarCalendarioPosponer(){var e=document.getElementById("calendar-posponer"),t=document.getElementById("fechaPosponer"),a=document.getElementById("modal-seleccionar-turno"),o=new Date;o.setHours(0,0,0,0);var r=new Date(o);r.setDate(o.getDate()),(calendarPosponer=new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",headerToolbar:{left:"prev",center:"title",right:"next"},events:[],dateClick:function(e){var n=new Date(e.dateStr);n.setHours(0,0,0,0);var s=new Date(o);s.setDate(o.getDate()+30),n<r||n>s||(t.value=e.dateStr,citaAdmin.fecha=e.dateStr,a.style.display="block",a.classList.add("mostrar"),setTimeout((()=>{a.style.animation="slideIn 0.5s forwards"}),10),a.style.pointerEvents="auto")},dayCellDidMount:function(e){var t=new Date(e.date);t.setHours(0,0,0,0),t<=r&&e.el.classList.add("disabled-day");var a=new Date(o);a.setDate(o.getDate()+30),t>a&&e.el.classList.add("disabled-day"),t.getTime()===o.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){const t=e.start.getMonth(),a=e.start.getFullYear(),r=new Date(o);r.setMonth(o.getMonth()-1);document.querySelector(".fc-prev-button").disabled=t===r.getMonth()&&a===r.getFullYear();document.querySelector(".fc-next-button").disabled=t===o.getMonth()&&a===o.getFullYear()}})).render()}function CerrarHoraCrear(){const e=document.querySelector("#modal-seleccionar-turno");e.style.animation="slideOut 0.5s forwards",setTimeout((()=>{e.style.display="none",e.classList.remove("show")}),500)}function cerrarmodalhorarios(){const e=document.getElementById("modal-seleccionar-turno");e.style.animation="slideOut 0.5s forwards",setTimeout((()=>{e.style.display="none",e.classList.remove("mostrar"),modal.style.pointerEvents="auto",e.style.pointerEvents="none"}),500)}function generarHorarios(e,t,a){let o=[],r=moment(e,"HH:mm"),n=moment(t,"HH:mm");for(;r<=n;)o.push(r.format("HH:mm")),r.add(a,"minutes");return o}function mostrarHorariosCrear(e){const t=document.querySelector("#horarios-crear");t.innerHTML="",t.style.display="flex";let a=[];const o=document.querySelector("#turno-manana"),r=document.querySelector("#turno-tarde");"manana"===e?(a=generarHorarios("08:00","11:30",30),o.classList.add("seleccionado"),r.classList.remove("seleccionado")):(a=generarHorarios("14:00","18:30",30),r.classList.add("seleccionado"),o.classList.remove("seleccionado")),a.forEach(((a,o)=>{const r=document.createElement("button");r.classList.add("botones","horario","botones-horarios","oculto"),r.textContent=a,r.style.backgroundColor="manana"===e?"#28a745":"#ff9800",r.addEventListener("click",(()=>seleccionarHoraCrear(a))),setTimeout((()=>{r.classList.remove("oculto"),r.classList.add("visible")}),100*o),t.appendChild(r)}))}function seleccionarHoraCrear(e){const t=document.querySelectorAll(".horario"),a=document.querySelector("#confirmar-modal-seleccionar");t.forEach((e=>e.classList.remove("seleccionado")));const o=Array.from(t).find((t=>t.textContent===e));o?(o.classList.add("seleccionado"),citaAdmin.hora=e,console.log(citaAdmin.hora),a.disabled=!1):(citaAdmin.hora=null,a.disabled=!0)}function mostrarHorariosPosponer(e){const t=document.querySelector("#horarios-posponer");t.innerHTML="",t.style.display="flex";let a=[];const o=document.querySelector("#turno-manana"),r=document.querySelector("#turno-tarde");"manana"===e?(a=generarHorarios("08:00","11:30",30),o.classList.add("seleccionado"),r.classList.remove("seleccionado")):(a=generarHorarios("14:00","18:30",30),r.classList.add("seleccionado"),o.classList.remove("seleccionado")),a.forEach(((a,o)=>{const r=document.createElement("button");r.classList.add("botones","horario","botones-horarios","oculto"),r.textContent=a,r.style.backgroundColor="manana"===e?"#28a745":"#ff9800",r.addEventListener("click",(()=>seleccionarHoraPosponer(a))),setTimeout((()=>{r.classList.remove("oculto"),r.classList.add("visible")}),100*o),t.appendChild(r)}))}function seleccionarHoraPosponer(e){const t=document.querySelectorAll(".horario"),a=document.querySelector("#btn-confirmar");t.forEach((e=>e.classList.remove("seleccionado")));const o=Array.from(t).find((t=>t.textContent===e));o?(o.classList.add("seleccionado"),citaAdmin.hora=e):citaAdmin.hora=null,a.disabled=!citaAdmin.hora,console.log("Hora seleccionada:",citaAdmin.hora),console.log("Botón confirmar habilitado:",!a.disabled)}function validarObservacion(){const e=document.querySelector("#observacion-textarea"),t=document.querySelector("#enviar-observacion"),a=e.value.trim();t.disabled=a.length<15}function abrirModalObservaciones(){if(!citaAdmin.hora)return void console.error("No se puede abrir el modal: No hay hora seleccionada.");const e=document.querySelector("#modal-observaciones");e.style.display="block",e.classList.add("show");const t=document.querySelector("#observacion-textarea"),a=document.querySelector("#enviar-observacion");t.value="",a.disabled=!0}function cerrarModalObservaciones(){const e=document.querySelector("#modal-observaciones");e.style.display="none",e.classList.remove("show")}function enviarFecha(){const e=document.querySelector("#observacion-textarea").value.trim(),t=citaAdmin.fecha,a=citaAdmin.hora,o=citaAdmin.id,r=citaAdmin.email,n=citaAdmin.usuarioId,s=document.getElementById("loading-spinner");e.length>=15&&t&&a&&o?(s.classList.add("show"),fetch("/api/posponerFechaAdmin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({observacion:e,fecha:t,hora:a,citaid:o,usuarioId:n,email:r})}).then((e=>e.text())).then((e=>{console.log("Respuesta cruda del servidor:",e);try{const t=JSON.parse(e);console.log("Respuesta JSON:",t),t.resultado?(s.classList.remove("show"),Swal.fire({icon:"success",title:"Turno Pospuesto",text:"El turno fue pospuesto correctamente.",button:"OK"}).then((()=>{setTimeout((()=>{window.location.reload()}),1e3)}))):alert("Hubo un problema al posponer el turno: "+(t.error||"Error desconocido"))}catch(e){console.error("Error al parsear JSON:",e),alert("Hubo un error al procesar la respuesta del servidor.")}})).catch((e=>{console.error("Error al enviar los datos:",e),alert("Hubo un error al enviar los datos al servidor.")}))):alert("Por favor, completa todos los campos correctamente.")}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()})),document.querySelector("#observacion-anular").addEventListener("input",(function(){const e=document.querySelector("#observacion-anular"),t=document.querySelector("#enviar-observacion-anular");e.value.length>15?t.disabled=!1:t.disabled=!0})),document.querySelector("#enviar-observacion-anular").addEventListener("click",(function(){AnularTurno(document.querySelector("#observacion-anular").value)}));