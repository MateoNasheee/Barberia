let paso=1;const pasoInicial=1,pasoFinal=3,cita={id:"",nombre:"",fecha:"",hora:"",servicios:[]};function iniciarApp(){mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),confirmarServicioEdicion(),idCliente(),nombreCliente(),seleccionarFecha(),inicializarCalendario(),inicializarCalendarioEdicion(),configurarModales()}function agregarServicio(){const e=document.getElementById("modal-servicio-agregar");e.style.display="block",e.classList.remove("hide"),e.classList.add("show"),cerrarModalHistorial(),consultarAPIAgregar()}function cerrarModalAgregado(){document.getElementById("modal-servicio-agregar").style.display="none",abrirModalHistorial()}window.addEventListener("load",(()=>{"true"===sessionStorage.getItem("openModalHistorial")&&(abrirModalHistorial(),sessionStorage.removeItem("openModalHistorial"))})),document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));let esTurnoCompleto=!1;function anularCita(){const e=document.getElementById("modal-anular");e.classList.add("show"),e.style.display="block",cerrarModalHistorial(),cerrarModalEditarHistorial()}function cerrarModalAnular(){const e=document.getElementById("modal-anular");e.classList.remove("show"),setTimeout((()=>{e.style.display="none"}),400)}function anularServicio(){const e=cita.servicioIdAntiguo,o=cita.citaId;console.log("Servicio a anular:",e),console.log("id de la cita: ",o),esTurnoCompleto?(anularTurnoCompleto(o),cerrarModalEditarHistorial()):fetch("/api/anularservicio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({servicioId:e,citaId:o})}).then((e=>e.json())).then((o=>{if(o.success){const o=document.querySelector(`[data-servicio-id="${e}"]`);o&&o.remove(),cerrarModalAnular(),cerrarModalEditarHistorial(),abrirModalHistorial()}else alert(o.message||"Hubo un error al anular el servicio. Inténtalo de nuevo.")})).catch((e=>{console.error("Error al intentar anular el servicio:",e),alert("Error en la solicitud. Inténtalo nuevamente."),document.querySelector(".loading-spinner").style.display="none"}))}function anularTurnoCompleto(e){const o=document.getElementById("loading-spinner");o.classList.add("show"),fetch("/api/anularturnocompleto",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({citaId:e})}).then((e=>e.json())).then((e=>{e.success?(o.classList.remove("show"),Swal.fire({icon:"success",title:"Turno Cancelado",text:"Tu turno fue cancelado correctamente",button:"OK"}).then((()=>{setTimeout((()=>{window.location.reload()}),1e3)}))):(alert(e.message||"Hubo un error al anular el turno. Inténtalo de nuevo."),document.querySelector(".loading-spinner").style.display="none")})).catch((e=>{console.error("Error al intentar anular el turno:",e),alert("Error en la solicitud. Inténtalo nuevamente."),document.querySelector(".loading-spinner").style.display="none"}))}function cerrarModalSeleccionEdicion(){const e=document.getElementById("modal-seleccion-edicion");e.classList.remove("show"),abrirModalEditarHistorial(),obtenerDetallesCita(),document.getElementById("blur-background3").style.display="none",document.getElementById("blur-background").style.display="none",setTimeout((()=>{e.style.display="none"}),300)}function cerrarModalFecha(){document.getElementById("modal-fecha").style.display="none",document.getElementById("blur-background").style.display="none",abrirModalEditarHistorial()}function filtrarServicios(){var e=document.getElementById("filtro-servicios").value,o=e.charAt(0).toUpperCase()+e.slice(1);document.getElementById("categoria-seleccionada").innerText=`Categoria seleccionada: ${o}`,document.querySelectorAll(".servicio").forEach((function(o){if("todos"===e)o.style.display="block";else{var t=o.getAttribute("data-categoria");o.style.display=t===e?"block":"none"}}))}function configurarModales(){const e=document.getElementById("modal"),o=document.getElementById("reservar-turno"),t=document.getElementById("cerrar-modal"),a=(document.getElementById("modal-seleccionar-turno"),document.getElementById("cerrar-modal-seleccionar"),document.getElementById("blur-background")),i=(document.getElementById("modal-blur-background"),document.getElementById("app")),r=document.querySelector(".barra");document.getElementById("dark-background");let n=window.innerWidth;o.addEventListener("click",(function(){consultarAPI(),n=window.innerWidth;const o=n-500;setTimeout((function(){calendar?(console.log("hola"),calendar.updateSize()):console.error("calendarAdmin no está inicializado.")}),300),i.style.width=`${o}px`,i.style.transition="width 0.5s",e.style.display="block",a.style.display="block",r.classList.add("modal-abierto"),document.body.style.overflow="hidden",e.classList.add("mostrar"),setTimeout((()=>{e.style.animation="slideIn 0.5s forwards"}),10)})),t.addEventListener("click",(function(){e.classList.remove("mostrar"),e.style.animation="slideOut 0.5s forwards",a.style.display="none",setTimeout((()=>{e.style.display="none",i.style.width=`${n}px`,r.classList.remove("modal-abierto"),document.body.style.overflow=""}),500)}))}function mostrarSeccion(){const e=document.querySelector(".seccion.mostrar");e&&e.classList.remove("mostrar");const o=`#paso-${paso}`;document.querySelector(o).classList.add("mostrar");const t=document.querySelector(".actual");t&&t.classList.remove("actual");document.querySelector(`[data-paso="${paso}"]`).classList.add("actual");document.querySelectorAll(".tabs button").forEach(((e,o)=>{o+1===paso?e.classList.remove("inactivo"):e.classList.add("inactivo")})),2===paso&&setTimeout((function(){console.log("Actualizando tamaño del calendario"),calendar&&calendar.updateSize()}),300)}function tabs(){document.querySelectorAll(".tabs button").forEach(((e,o)=>{e.classList.add("inactivo"),o+1===paso&&e.classList.remove("inactivo"),e.addEventListener("click",(function(e){e.preventDefault()}))}))}function botonesPaginador(){const e=document.querySelector("#anterior"),o=document.querySelector("#siguiente");1===paso?(e.classList.add("ocultar"),o.classList.remove("ocultar"),0===cita.servicios.length?o.disabled=!0:o.disabled=!1):3===paso?(e.classList.remove("ocultar"),o.classList.add("ocultar"),mostrarResumen()):2===paso?(e.classList.remove("ocultar"),o.classList.add("ocultar")):(e.classList.remove("ocultar"),o.classList.remove("ocultar")),mostrarSeccion()}function paginaAnterior(){document.querySelector("#anterior").addEventListener("click",(function(){paso<=1||(paso--,botonesPaginador())}))}function paginaSiguiente(){document.querySelector("#siguiente").addEventListener("click",(function(){paso>=3||(paso++,botonesPaginador())}))}function mostrarServiciosAgregar(e){console.log("buenas",cita.servicioIdAntiguo);const o=document.querySelector("#servicios-edicion-agregar");o.innerHTML="";e.filter((e=>!cita.serviciosSacar.includes(e.id))).forEach((e=>{const{id:t,nombre:a,precio:i}=e,r=document.createElement("P");r.classList.add("nombre-servicio"),r.textContent=a;const n=document.createElement("P");n.classList.add("precio-servicio"),n.textContent=`$${i}`;const c=document.createElement("DIV");c.classList.add("servicio3"),c.dataset.idServicio=t,c.onclick=function(){seleccionarServicioAgregar(e)},c.appendChild(r),c.appendChild(n),o.appendChild(c)}))}function seleccionarServicioAgregar(e){const{id:o}=e,{servicios:t}=cita,a=document.querySelector(`#servicios-edicion-agregar [data-id-servicio="${o}"]`);t.some((e=>e.id===o))?(cita.servicios=t.filter((e=>e.id!==o)),a.classList.remove("seleccionado3")):(cita.servicios=[...t,e],a.classList.add("seleccionado3"));document.querySelector("#btn-confirmar-servicio-agregar").disabled=0===cita.servicios.length}function cerrarModalServicioAgregar(){document.getElementById("modal-servicio-agregar").style.display="none",abrirModalHistorial()}async function confirmarServicioAgregar(){const e=cita.servicios,o=cita.citaid;console.log("listado",e),console.log("citaid",o);const t=document.getElementById("loading-spinner");if(t.classList.add("show"),e.length>0)try{const t="/api/agregarServicio",a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({serviciosIds:e.map((e=>e.id)),citaId:o})});if(console.log(a),a.ok){console.log(a.ok);const e=a.headers.get("content-type");if(e&&e.includes("application/json")){const e=await a.json();console.log("Servicios actualizados:",e),e.resultado?Swal.fire({icon:"success",title:"Servicio Agregado",text:"Tu servicio fue agregado correctamente",button:"OK"}).then((()=>{sessionStorage.setItem("openModalHistorial","true"),setTimeout((()=>{window.location.reload()}),1e3)})):console.error("Error en la actualización:",e.error)}else console.error("Error: Respuesta no es JSON")}else console.error("Error al actualizar el servicio:",a.status)}catch(e){console.error("Error al enviar la solicitud:",e)}finally{t.classList.remove("show")}else console.error("No hay servicios seleccionados."),t.classList.remove("show")}function mostrarServiciosEdicion(e){const o=document.querySelector("#servicios-edicion");o.innerHTML="",e.forEach((e=>{const{id:t,nombre:a,precio:i}=e,r=document.createElement("P");r.classList.add("nombre-servicio"),r.textContent=a;const n=document.createElement("P");n.classList.add("precio-servicio"),n.textContent=`$${i}`;const c=document.createElement("DIV");c.classList.add("servicio2"),c.dataset.idServicio=t,cita.servicioEditable&&cita.servicioEditable.nombre===a&&c.classList.add("seleccionado"),c.onclick=function(){seleccionarServicioEdicion(e)},c.appendChild(r),c.appendChild(n),o.appendChild(c)}))}function seleccionarServicioEdicion(e){const{id:o,nombre:t}=e,a=document.querySelector(`#servicios-edicion [data-id-servicio="${o}"]`);if(cita.servicioEditable&&cita.servicioEditable.nombre===t)a.classList.remove("seleccionado"),cita.servicioEditable=null;else{if(cita.servicioEditable){const e=document.querySelector(`#servicios-edicion [data-id-servicio="${cita.servicioEditable.id}"]`);e&&e.classList.remove("seleccionado")}cita.servicioEditable={id:o,nombre:t},console.log(cita.servicioEditable),a.classList.add("seleccionado")}document.querySelector("#btn-confirmar-servicio").disabled=!cita.servicioEditable}async function confirmarServicioEdicion(){const e=cita.servicioEditable,o=cita.servicioIdAntiguo,t=cita.citaId;console.log(cita.servicioIdAntiguo);const a=document.getElementById("loading-spinner");if(a.classList.add("show"),e)try{const a="/api/actualizarservicioeditable",i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({servicioIdAntiguo:o,servicioIdNuevo:e.id,citaId:t})});if(i.ok){const e=i.headers.get("content-type");if(e&&e.includes("application/json")){const e=await i.json();console.log("Servicio actualizado:",e),e.resultado?(cerrarModalServicio(),cerrarModalEditarHistorial(),cerrarModalSeleccion()):console.error("Error en la actualización:",e.error)}else console.error("Error: Respuesta no es JSON")}else console.error("Error al actualizar el servicio:",i.status)}catch(e){console.error("Error al enviar la solicitud:",e)}finally{a.classList.remove("show")}else a.classList.remove("show")}function cerrarModalSeleccion(){const e=document.getElementById("modal-seleccion-edicion");e.classList.remove("show"),setTimeout((()=>{e.style.display="none"}),300)}async function consultarAPIAgregar(){try{const e="/api/servicios-agregar",o=await fetch(e);mostrarServiciosAgregar(await o.json()),mos}catch(e){console.log(e)}}async function consultarAPIEdicion(){try{const e="/api/servicios-edicion",o=await fetch(e);mostrarServiciosEdicion(await o.json()),mos}catch(e){console.log(e)}}function seleccionarServicio(e){console.log(e);const{id:o}=e,{servicios:t}=cita,a=document.querySelector(`#servicios [data-id-servicio="${o}"]`);t.some((e=>e.id===o))?(cita.servicios=t.filter((e=>e.id!==o)),a.classList.remove("seleccionado")):(cita.servicios=[...t,e],a.classList.add("seleccionado")),calcularDuracionServicios();document.querySelector("#siguiente").disabled=0===cita.servicios.length}function idCliente(){const e=document.querySelector("#id");console.log("Campo #id:",e),e?(cita.id=e.value,console.log("holaaaaaa",cita.id)):console.error("El campo #id no fue encontrado.")}function nombreCliente(){cita.nombre=document.querySelector("#nombre").value}var calendar2;function inicializarCalendarioEdicion(){var e=document.getElementById("calendar2"),o=document.getElementById("fecha"),t=document.getElementById("modal-seleccionar-turno-editar");document.querySelector("#modal");var a=new Date;a.setHours(0,0,0,0);var i=new Date(a);i.setDate(a.getDate()-1),(calendar2=new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",headerToolbar:{left:"prev",center:"title",right:"next"},events:[],dateClick:function(e){var r=new Date(e.dateStr);r.setHours(0,0,0,0);var n=new Date(a);n.setDate(a.getDate()+30),r<i||r>n||(o.value=e.dateStr,cita.fecha=e.dateStr,ConsultarHorarios(cita.fecha),t.style.display="block",t.classList.add("mostrar"),setTimeout((()=>{t.style.animation="slideIn 0.5s forwards"}),10),t.style.pointerEvents="auto")},dayCellDidMount:function(e){var o=new Date(e.date);o.setHours(0,0,0,0),o<=i&&e.el.classList.add("disabled-day");var t=new Date(a);t.setDate(a.getDate()+30),o>t&&e.el.classList.add("disabled-day"),o.getTime()===a.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){const o=e.start.getMonth(),t=e.start.getFullYear(),i=new Date(a);i.setMonth(a.getMonth()-1);document.querySelector(".fc-prev-button").disabled=o===i.getMonth()&&t===i.getFullYear();document.querySelector(".fc-next-button").disabled=o===a.getMonth()&&t===a.getFullYear()}})).render()}function editarFecha(){cerrarModalSeleccion();const e=document.getElementById("modal-fecha");e.classList.add("show"),e.style.display="block",setTimeout((function(){calendar2&&calendar2.updateSize()}),300)}function seleccionarHoraEdicion(e){event.preventDefault();document.querySelector("#modal");const o=document.querySelectorAll(".horario");let t=document.querySelector("#cerrar-modal-seleccionar");const a=Array.from(o).find((o=>o.textContent===e));if(a)if(a.classList.contains("seleccionado")){console.log(`Deseleccionando la hora: ${e}`),a.classList.remove("seleccionado"),cita.hora=null;Array.from(o).some((e=>e.classList.contains("seleccionado")))||(t.textContent="Cerrar",t.classList.remove("confirmar-seleccion"))}else console.log(`Seleccionando la hora: ${e}`),o.forEach((e=>e.classList.remove("seleccionado"))),a.classList.add("seleccionado"),cita.hora=e,console.log(`Hora seleccionada: ${cita.hora}`),console.log(`Fecha seleccionada: ${cita.fecha}`),t.textContent="Confirmar",t.classList.add("confirmar-seleccion"),t.addEventListener("click",(function(){const e=document.getElementById("loading-spinner");if(e.classList.add("show"),cita.hora&&cita.fecha){console.log("Confirmando selección y enviando datos a la API...");const o=cita.citaid,t=cita.usuarioId;console.log(`Enviando Fecha: ${cita.fecha} y Hora: ${cita.hora}`,"cita: ",o,"usuario: ",t),fetch("/api/actualizarturno",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:cita.fecha,hora:cita.hora,citaid:o,usuarioId:t})}).then((e=>{if(!e.ok)throw new Error("Error en la respuesta del servidor: "+e.statusText);return e.json()})).then((o=>{console.log("Respuesta del servidor:",o),o.resultado?(console.log("Cita actualizada exitosamente."),document.querySelector("#modal-fecha").style.display="none",document.querySelector("#modal-seleccion-edicion").style.display="none",document.querySelector("#blur-background").style.display="none",document.querySelector("#blur-background3").style.display="none",e.classList.remove("show"),abrirModalHistorial(),cita.fecha=null,cita.hora=null):(console.error("Error en la actualización:",o.error),alert("Ocurrió un error: "+o.error))})).catch((e=>{console.error("Error al actualizar cita:",e.message),alert("Ocurrió un error al actualizar la cita: "+e.message)}))}else console.warn("Fecha o hora no seleccionadas. No se puede confirmar la cita."),alert("Por favor selecciona una fecha y una hora antes de confirmar.")}),{once:!0});else console.warn(`Hora ${e} no encontrada en los botones de horario.`)}function abrirModalHistorial(){fetch("/api/historial-citas").then((e=>{if(!e.ok)throw new Error("Error en la solicitud al servidor");return e.json()})).then((e=>{const o=document.getElementById("historial-content");if(o.innerHTML="",document.getElementById("blur-background").style.display="block",e.success){const t=e.historial.filter((e=>2!==parseInt(e.estado)));if(0===t.length)o.innerText="No hay citas disponibles.";else{const e={};t.forEach((o=>{const t=`${o.fecha} ${o.hora.slice(0,5)}`;e[t]||(e[t]=[]),e[t].push(o)})),Object.keys(e).forEach((t=>{const a=document.createElement("div");a.className="grupo-cita";const[i,r]=t.split(" ");a.innerHTML=`\n                        <div class="info-fecha-hora">\n                            <div class="fecha-hora">\n                                <div><strong>Fecha:</strong> <span class="item">${i}</span></div>\n                                <div><strong>Hora:</strong> <span class="item">${r}</span></div>\n                            </div>\n                            <div class="iconos-historial">\n                            <i class="fas fa-plus icono-agregar" title="Añadir servicio"></i>\n                            <i class="fas fa-pencil-alt icono-lapiz" title="Posponer fecha" data-id="${t}"></i>\n                            <i class="fas fa-trash-alt icono-basura" title="Anular turno completo"></i>\n                            \n                            </div>\n                        </div>\n                    `;a.querySelector(".icono-agregar").addEventListener("click",(function(){const o=e[t][0].citaId;cita.citaid=o,console.log("la cita es: ",cita.citaid),cita.serviciosSacar=e[t].map((e=>e.servicioId)),console.log("Servicios agregados: ",cita.serviciosSacar),agregarServicio()}));a.querySelector(".icono-lapiz").addEventListener("click",(function(){const o=e[t][0].citaId,a=e[t][0].usuarioId;cita.citaid=o,cita.usuarioId=a,console.log("la cita es: ",cita.citaid,"el usuario es: ",cita.usuarioId),editarFecha()}));a.querySelector(".icono-basura").addEventListener("click",(function(){anularTurnoCompleto(e[t][0].citaId)})),e[t].forEach((e=>{const o=parseInt(e.servicioPrecio).toLocaleString("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0}),t=document.createElement("div");t.className="cita",t.setAttribute("data-id",e.servicioId),t.setAttribute("data-cita-id",e.citaId),t.innerHTML=`\n                                <div class="info">\n                                    <div class="etiqueta">\n                                        <i class="fas fa-concierge-bell"></i> <strong>Servicio:</strong> <span class="item">${e.servicioNombre||"No especificado"}</span>\n                                    </div>\n                                </div>\n                                <div class="precio-container">\n                                    <span class="precio">${o}</span>\n                                </div>\n                            `,t.addEventListener("click",(function(){const e=this.getAttribute("data-id"),o=this.getAttribute("data-cita-id");cita.citaId=o,console.log(e),console.log("cita",cita.citaId),abrirModalEditarHistorial(e)})),a.appendChild(t)})),1===e[t].length&&(esTurnoCompleto=!0,console.log(esTurnoCompleto)),o.appendChild(a)}))}}else o.innerText="No se pudo cargar el historial de citas."})).catch((e=>{document.getElementById("historial-content").innerText="Ocurrió un error al obtener el historial de citas.",console.error("Error:",e)}));const e=document.getElementById("modal-historial");e.style.display="block",setTimeout((()=>{e.classList.add("show")}),10)}function editarCita(){const e=document.getElementById("modal-seleccion-edicion");e.classList.add("show"),e.style.display="block",document.getElementById("blur-background3").style.display="none",cerrarModalEditarHistorial(),cerrarModalHistorial()}function cerrarModalHistorial(){const e=document.getElementById("modal-historial");e.classList.remove("show"),e.classList.add("hide"),document.getElementById("blur-background").style.display="none",setTimeout((()=>{e.style.display="none",e.classList.remove("hide")}),250)}function abrirModalEditarHistorial(e){console.log("ID del servicio:",e),cita.servicioIdAntiguo=e,fetch("/api/guardar-servicio-en-sesion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({servicioId:e})}).then((e=>{if(!e.ok)throw new Error("Error en la solicitud al servidor");return e.json()})).then((e=>{console.log(e),e.success?obtenerDetallesServicio():console.error(e.message||"No se pudo guardar el ID del servicio en la sesión")})).catch((e=>{console.error("Error:",e)}))}function obtenerDetallesServicio(){fetch("/api/historial-citas/detalles-servicio").then((e=>{if(!e.ok)throw new Error("Error en la solicitud al servidor");return e.json()})).then((e=>{console.log(e);const o=document.getElementById("editar-content");if(o.innerHTML="",e.success){const t=e.servicio,a=parseInt(t.precio).toLocaleString("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0});cita.servicioEditable={nombre:t.nombre},o.innerHTML=`\n                    <div class="etiqueta"><strong>Servicio:</strong> <span class="item">${t.nombre||"No especificado"}</span></div>\n                    <div class="etiqueta"><strong>Precio:</strong> <span class="item">${a}</span></div>\n                `;const i=document.getElementById("modal-editar-historial");i.classList.remove("hide"),i.classList.add("show"),i.style.display="block",cerrarModalHistorial(),document.getElementById("blur-background3").style.display="block"}else o.innerText="No se pudo cargar los detalles del servicio."})).catch((e=>{console.error("Error:",e),document.getElementById("editar-content").innerText="Ocurrió un error al obtener los detalles del servicio."}))}function obtenerDetallesCita(){fetch("/api/historial-citas/detalles").then((e=>{if(!e.ok)throw new Error("Error en la solicitud al servidor");return e.json()})).then((e=>{const o=document.getElementById("editar-content");if(o.innerHTML="",e.success){const o=e.cita;parseInt(o.servicioPrecio).toLocaleString("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0}),o.hora.slice(0,5);cita.servicioIdAntiguo=o.servicioId,cita.fechaAntigua=o.fecha,cita.id=o.citaId,console.log(cita.id)}else o.innerText="No se pudo cargar los detalles de la cita."})).catch((e=>{console.error("Error:",e),document.getElementById("editar-content").innerText="Ocurrió un error al obtener los detalles de la cita."}))}function cerrarModalEditarHistorial(){const e=document.getElementById("modal-editar-historial");document.getElementById("blur-background3").style.display="none",e.classList.remove("show"),e.classList.add("hide"),abrirModalHistorial(),setTimeout((()=>{e.style.display="none"}),300)}let calendar;function inicializarCalendario(){var e=document.getElementById("calendar"),o=document.getElementById("fecha"),t=document.getElementById("modal-seleccionar-turno");document.querySelector("#modal");var a=new Date;a.setHours(0,0,0,0),new Date(a).setDate(a.getDate()+30);var i=new Date(a),r=new Date(a);r.setDate(a.getDate()+30);var n=new Date(a);n.setMonth(a.getMonth()+1),n.setDate(1),calendar=new FullCalendar.Calendar(e,{locale:"es",initialView:"dayGridMonth",initialDate:a,headerToolbar:{left:"prev",center:"title",right:"next"},selectable:!0,selectMirror:!0,events:[],validRange:{start:i,end:r},dateClick:function(e){var a=new Date(e.dateStr);if(a.setHours(0,0,0,0),a<i||a>r)return;document.querySelectorAll(".fc-daygrid-day").forEach((function(e){e.classList.remove("selected")}));const n=a.getUTCDay();[6].includes(n)||(e.dayEl.classList.add("selected"),o.value=e.dateStr,cita.fecha=e.dateStr,ConsultarHorarios(cita.fecha),t.style.display="block",t.classList.add("mostrar"),setTimeout((()=>{t.style.animation="slideIn 0.5s forwards"}),10),t.style.pointerEvents="auto"),[6].includes(n)&&(o.value="")},dayCellDidMount:function(e){var o=new Date(e.date);o.setHours(0,0,0,0),(o<i||o>r)&&e.el.classList.add("disabled-day"),o.getTime()===a.getTime()&&e.el.classList.add("current-day")},datesSet:function(e){const o=e.start.getMonth(),t=e.start.getFullYear(),i=new Date(a);i.setMonth(a.getMonth()+1),i.setFullYear(a.getFullYear());new Date(t,o,1);const r=o===a.getMonth()&&t===a.getFullYear(),n=o===i.getMonth()&&t===i.getFullYear();document.querySelector(".fc-prev-button").disabled=r;document.querySelector(".fc-next-button").disabled=n}}),calendar.render()}let horariosOcupados=[];function ConsultarHorarios(e){e?fetch("/api/consultarHorarios",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:e})}).then((e=>e.json())).then((e=>{e.error?alert("Error: "+e.error):(horariosOcupados=e.map((e=>({hora:e.hora.slice(0,5),duracion:parseInt(e.duracionTotal,10),estado:parseInt(e.estado,10)}))),console.log("Horarios ocupados con duración y estado:",horariosOcupados))})).catch((e=>{console.error("Error al obtener los horarios:",e)})):console.error("No se ha seleccionado una fecha válida.")}function mostrarHorarios(e){const o=document.querySelector("#horarios");o.innerHTML="",o.style.display="block";let t=[];const a=document.querySelector("#turno-manana"),i=document.querySelector("#turno-tarde");"manana"===e?(t=generarHorarios("08:00","11:30",30),a.classList.add("seleccionado"),i.classList.remove("seleccionado")):(t=generarHorarios("14:00","18:30",30),i.classList.add("seleccionado"),a.classList.remove("seleccionado")),t.forEach(((a,i)=>{const r=document.createElement("BUTTON");r.classList.add("botones","horario","botones-horarios"),r.textContent=a;const n=cita.duracionTotal,c=Math.ceil(n/30),s=!horariosOcupados.some((({hora:e,duracion:o,estado:t})=>{if(2===t)return!1;const i=moment(e,"HH:mm"),r=i.clone().add(o,"minutes"),c=moment(a,"HH:mm"),s=c.clone().add(n,"minutes");return c.isBetween(i,r,null,"[)")||s.isBetween(i,r,null,"[)")})),l=t.slice(i,i+c).every((e=>{const o=moment(e,"HH:mm");return!horariosOcupados.some((({hora:e,duracion:t,estado:a})=>{if(2===a)return!1;const i=moment(e,"HH:mm"),r=i.clone().add(t,"minutes");return o.isBetween(i,r,null,"[)")}))}));s&&l?(r.addEventListener("click",(()=>seleccionarHora(a))),r.style.backgroundColor="manana"===e?"#4caf50":"#ff9800"):(r.setAttribute("disabled","true"),r.style.backgroundColor="#ccc"),setTimeout((()=>{r.classList.add("visible")}),100*i),o.appendChild(r)})),cita.hora=null,toggleConfirmButton()}function mostrarHorariosEdicion(e){const o=document.querySelector("#horarios2");o.innerHTML="",o.style.display="block";let t=[];const a=document.querySelector("#turno-manana"),i=document.querySelector("#turno-tarde");"manana"===e?(t=generarHorarios("08:00","11:30",30),a.classList.add("seleccionado"),i.classList.remove("seleccionado")):(t=generarHorarios("14:00","18:30",30),i.classList.add("seleccionado"),a.classList.remove("seleccionado")),t.forEach(((a,i)=>{const r=document.createElement("BUTTON");r.classList.add("botones","horario","botones-horarios"),r.textContent=a;const n=cita.duracionTotal,c=Math.ceil(n/30),s=!horariosOcupados.some((({hora:e,duracion:o,estado:t})=>{if(2===t)return!1;const i=moment(e,"HH:mm"),r=i.clone().add(o,"minutes"),c=moment(a,"HH:mm"),s=c.clone().add(n,"minutes");return c.isBetween(i,r,null,"[)")||s.isBetween(i,r,null,"[)")})),l=t.slice(i,i+c).every((e=>{const o=moment(e,"HH:mm");return!horariosOcupados.some((({hora:e,duracion:t,estado:a})=>{if(2===a)return!1;const i=moment(e,"HH:mm"),r=i.clone().add(t,"minutes");return o.isBetween(i,r,null,"[)")}))}));s&&l?(r.addEventListener("click",(()=>seleccionarHora(a))),r.style.backgroundColor="manana"===e?"#4caf50":"#ff9800"):(r.setAttribute("disabled","true"),r.style.backgroundColor="#ccc"),setTimeout((()=>{r.classList.add("visible")}),100*i),o.appendChild(r)})),cita.hora=null,toggleConfirmButton()}function generarHorarios(e,o,t){let a=[],i=moment(e,"HH:mm"),r=moment(o,"HH:mm");for(;i<=r;)a.push(i.format("HH:mm")),i.add(t,"minutes");return a}function toggleConfirmButton(){const e=document.getElementById("confirmar-modal-seleccionar");cita.hora?e.removeAttribute("disabled"):e.setAttribute("disabled","true")}function seleccionarHora(e){const o=document.querySelectorAll(".horario"),t=(document.querySelector("#cerrar-modal-seleccionar"),Array.from(o).find((o=>o.textContent===e)));t&&(t.classList.contains("seleccionado")?(t.classList.remove("seleccionado"),cita.hora=null):(o.forEach((e=>e.classList.remove("seleccionado"))),t.classList.add("seleccionado"),cita.hora=e,console.log(cita.hora)),toggleConfirmButton())}function confirmar(){if(cita.hora&&cita.fecha){if(cita.servicios&&cita.servicios.length>0)console.log("Creando nueva cita"),paso=3,console.log("Cita confirmada con servicios:",cita.servicios),botonesPaginador();else{const e=document.getElementById("loading-spinner");e.classList.add("show"),console.log("Posponiendo cita"),console.log(cita.fecha,cita.hora);const o=cita.citaid,t=cita.usuarioId;console.log(`Enviando Fecha: ${cita.fecha} y Hora: ${cita.hora}`,"cita: ",o,"usuario: ",t),fetch("/api/actualizarturno",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fecha:cita.fecha,hora:cita.hora,citaid:o,usuarioId:t})}).then((e=>{if(!e.ok)throw new Error("Error en la respuesta del servidor: "+e.statusText);return e.json()})).then((o=>{console.log("Respuesta del servidor:",o),o.resultado?(console.log("Cita actualizada exitosamente."),document.querySelector("#modal-fecha").style.display="none",document.querySelector("#modal-seleccion-edicion").style.display="none",document.querySelector("#blur-background").style.display="none",document.querySelector("#blur-background3").style.display="none",e.classList.remove("show"),abrirModalHistorial(),cita.fecha=null,cita.hora=null):(console.error("Error en la actualización:",o.error),alert("Ocurrió un error: "+o.error))})).catch((e=>{console.error("Error al actualizar cita:",e.message),alert("Ocurrió un error al actualizar la cita: "+e.message)}))}cerrarModalSecun()}else console.log("Faltan datos: Hora y fecha son necesarios")}function cerrarModalSecun(){const e=document.getElementById("modal"),o=document.getElementById("modal-seleccionar-turno-editar"),t=document.querySelector(".dark-background"),a=document.getElementById("blur-background");o.style.animation="slideOut 0.5s forwards",o.style.pointerEvents="none",t.style.display="none",setTimeout((()=>{o.style.display="none",o.classList.remove("mostrar"),o.style.pointerEvents="none",e.style.pointerEvents="auto",a.style.display="block"}),500)}function calcularDuracionServicios(){let e=0;cita.servicios.forEach((o=>{let t=parseInt(o.duracion,10);isNaN(t)||(e+=t)})),cita.duracionTotal=e,console.log(cita.duracionTotal)}async function consultarHorariosOcupados(e){const o=`/api/horarios-ocupados?fecha=${e}`,t=await fetch(o),a=await t.json(),i=horarios.filter((e=>!a.includes(e)));mostrarHorariosDisponibles(i)}function seleccionarFecha(){document.querySelector("#fecha").addEventListener("input",(function(e){const o=new Date(e.target.value).getUTCDay();[6,0].includes(o)?(e.target.value="",mostrarAlerta("Fines de semana no permitidos","error",".formulario")):cita.fecha=e.target.value}))}function mostrarAlerta(e,o,t,a=!0){const i=document.querySelector(".alerta");i&&i.remove();const r=document.createElement("DIV");r.textContent=e,r.classList.add("alerta"),r.classList.add(o);document.querySelector(t).appendChild(r),a&&setTimeout((()=>{r.remove()}),3e3)}function mostrarResumen(){const e=document.querySelector(".contenido-resumen");for(console.log("Cita actual:",cita);e.firstChild;)e.removeChild(e.firstChild);if(Object.values(cita).includes("")||0===cita.servicios.length)return void mostrarAlerta("Faltan datos de Servicios, Fecha u Hora","error",".contenido-resumen",!1);calcularDuracionServicios();let o=0;cita.servicios.forEach((e=>{o+=parseFloat(e.precio)}));const{nombre:t,fecha:a,hora:i,servicios:r}=cita,n=document.createElement("H3");n.textContent="Resumen de Servicios",e.appendChild(n),r.forEach((o=>{const{id:t,precio:a,nombre:i}=o,r=document.createElement("DIV");r.classList.add("contenedor-servicio");const n=document.createElement("P");n.textContent=i;const c=document.createElement("P");c.innerHTML=`<span>Precio:</span> $${a}`,r.appendChild(n),r.appendChild(c),e.appendChild(r)}));const c=document.createElement("H3");c.textContent="Resumen de Cita",e.appendChild(c);const s=document.createElement("P");s.innerHTML=`<span>Nombre:</span> ${t}`;const l=new Date(a),d=l.getMonth(),u=l.getDate()+2,m=l.getFullYear(),g=new Date(Date.UTC(m,d,u)).toLocaleDateString("es-AR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),h=document.createElement("P");h.innerHTML=`<span>Fecha:</span> ${g}`;const y=document.createElement("P");y.innerHTML=`<span>Hora:</span> ${i} Horas`;const p=document.createElement("P");p.innerHTML=`<span>Duración total:</span> ${cita.duracionTotal} minutos`;const v=document.createElement("P");v.innerHTML=`<span>Total precio:</span> $${o.toFixed(2)}`;const f=document.createElement("BUTTON");f.classList.add("boton"),f.textContent="Reservar Cita",f.onclick=reservarCita,e.appendChild(s),e.appendChild(h),e.appendChild(y),e.appendChild(p),e.appendChild(v),e.appendChild(f)}async function reservarCita(){const{nombre:e,fecha:o,hora:t,servicios:a,id:i,duracionTotal:r}=cita,n=a.map((e=>e.id)),c=document.getElementById("loading-spinner");c.classList.add("show");const s=new FormData;s.append("fecha",o),s.append("hora",t),s.append("usuarioId",i),s.append("servicios",n),s.append("duracionTotal",r),console.log([...s]);try{const e="/api/citas",o=await fetch(e,{method:"POST",body:s}),t=await o.json();console.log(t),c.classList.remove("show"),t.resultado&&Swal.fire({icon:"success",title:"Cita Creada",text:"Tu cita fue creada correctamente",button:"OK"}).then((()=>{setTimeout((()=>{window.location.reload()}),1e3)}))}catch(e){Swal.fire({icon:"error",title:"Error",text:"Hubo un error al guardar la cita"})}}